Ceph RBD 块设备提供了很多特性与功能

这里所指的镜像与卷是同一个概念，通常在传统存储中称之为卷，在互联网领域中称之为镜像，这里我们统一称之为镜像。

### 特性

* layering：提供镜像分层特性，实现镜像克隆功能，该特性开启后，每个镜像都可以有其父镜像 —— 该镜像为其父镜像的一个克隆
* striping：条带化功能，开启后支持数据条带化，让数据可以在一组对象集（Object Sets）上实现条带化功能（就像 RAID0 一样，RAID0 中，条带化功能底层使用了多个物理磁盘，而这里底层使用的是多个Objects），如下图：

  ```
  ![](/assets/feature_1.png)
  ```

* exclusive-lock：乐观锁，开启该功能后，块设备自带乐观锁功能，能够序列化多个客户端同时下发该块设备的请求，而无需用户在使用块设备时，进行主动加锁功能。

* object-map：对象映射表，开启后，Ceph 将为该块设备记录对象映射表，对象映射表描述了哪些对象在OSD上是真实存在的。由于 Ceph 镜像的创建和使用是瘦分配，只有当数据真正写入时，才会在 OSD 上生成真实的对象，并占用磁盘的物理空间。而如果不记录对象映射表，用户在访问从父镜像克隆出来的子镜像，删除镜像，统计镜像使用率时，必须去后端扫描对象是否存储，这对于网络存储来说效率非常低。Ceph 通过记录对象映射表，使得客户端能够直接查询映射表，得知特定的 Object 是否在后端存在。
* fast-diff：快速比对镜像差异的特性依赖于object-map，如需开启此功能必须开启object-map。object-map 提供对象映射表，实现快照之间差异的快速比对。

* deep-flatten：对镜像进行flatten操作后，只有当前镜像会被flatten，而该镜像的快照不会被flatten。开启该功能后，能够保证镜像的快照也能够被正确的flatten。

* journaling：镜像日志功能，用于实现rbd-mirror，开启后，Ceph 会为该镜像的所有更新操作记录操作日志，该日志可以在 mirror  镜像上进行回放，实现 mirror 功能。

### 功能

RBD 块设备提供如下功能：

| 功能 | 描述 |
| :--- | :--- |
| 镜像创建 | 创建一个RBD镜像 |
| 镜像删除 | 删除一个RBD镜像 |
| 镜像扩容 | 可以在线为一个RBD镜像增加可使用容量 |
| 镜像缩容 | 可以在线为一个RBD镜像减小可使用容量，但可能在减小可使用容量过程中，造成部分数据丢失，谨慎使用 |
| 镜像快照创建 | 能够创建实时镜像快照，镜像快照基于Copy-On-Write实现，对于任何容量的镜像，快照的创建在秒级以内完成 |
| 镜像快照删除 | 能够删除镜像快照，删除过程为异步删除，删除动作在秒级以内完成，Ceph 将通过对象回收将快照对象逐个删除 |
| 镜像快照差分导出 | 能够导出两个镜像快照之间的差异 |
| 镜像快照差分导入 | 基于差分导出（from － to），能够对一个已经拥有from状态快照的镜像进行差分导入，导入后镜像将拥有to状态的镜像快照。 |
| 镜像克隆 | 能够以一个被保护的镜像快照作为父镜像，克隆并生成子镜像，子镜像内容在修改之前与父镜像内容完全相同。该功能基于Copy-On-Write实现，克隆镜像的创建在秒级以内完成 |
| 镜像悲观锁 | Ceph 为每一个 RBD 块设备提供悲观锁功能，用户在使用前可以对该镜像主动加锁，以防止多个用户同时使用一个镜像 |
| 镜像乐观锁 | 需开启exclusive-lock，开启后自动生效，Ceph 集群层将自动保障多个客户端的并发访问严格按序进行。 |
| 镜像数据块大小设定 | 能够根据业务类型，调整镜像分片的大小（即 Object Size） |
| 镜像条带化设定 | 开启 stripping 特性后，可以设置镜像在一组对象集之间进行条带化，提供访问并发度。 |



